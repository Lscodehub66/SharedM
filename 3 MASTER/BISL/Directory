//let Code = Load("Directory","Code"), EVA = Expression.Evaluate(Code ,#shared) in EVA
let
     #"Buffered Ancient" = Table.Buffer(CWB("BISL_Ancient")),
    #"Buffered mDeal" = Table.Buffer(CWB("deal_master")),
     JLMtbl = Table.RenameColumns(Table.SelectColumns(CWB("BISL_JLMPeers"),{"Check", "JGC","JBR"},MissingField.Ignore),{{"Check", "Check.Dummy"}},MissingField.Ignore),
    CN_Base = List.Buffer(CWB("BaseDirectory_CN")),
    CN_CWB = List.Buffer(Table.ColumnNames(CWB("Directory"))),
    //
    Ancient_Merged = Load("fxDBMerger")(#"Buffered Ancient"),
    Ancient_Finalized = Load("fxDBFinalization")(Ancient_Merged),
    deal_masterFiltered = Table.SelectRows(#"Buffered mDeal", each [BISL_ROLE] <> "" and [BISL_ROLE] <> "--"),
    Combined = fx("Combine")({Ancient_Finalized, deal_masterFiltered}, null, {1}),
    Checked =fx("CheckNDupe")(Combined),
    MergedQ = fx("Merge")(Checked, CWB("Table_PRJMerge"), "COMPARER", "COMPARER", {"承销费原币"}, {""}),
   
    MergedQ2 = fx("Merge")(  MergedQ , JLMtbl,"Check","Check.Dummy",{"JGC","JBR"},{"JGC","JBR"}),
    NthMandate = fx("NthMandated")(MergedQ2, {"YYMMDD", "信用主体"}),
    #"Count Multi-Tranche" = fx("AddMultiCount")(NthMandate),
    ExeTime =
        if Table.HasColumns(#"Count Multi-Tranche", "Date_Onboarded") then
            Table.AddColumn(
                #"Count Multi-Tranche",
                "执行周期",
                each
                    if not List.Contains({[定价日], [Date_Onboarded]}, null) and [定价日] >= [Date_Onboarded] then
                        Duration.Days([定价日] - [Date_Onboarded])
                    else
                        null,
                type number
            )
        else
            #"Count Multi-Tranche",
    Sorted = fx("SortNIndex")(ExeTime),
    ReplacedCCY = Table.ReplaceValue(Sorted, "美元债", "", Replacer.ReplaceValue, {"货币细分"}),
    Reordered = Table.ReorderColumns(
        ReplacedCCY,
        CN_Base & List.RemoveItems(CN_CWB, CN_Base),
        MissingField.Ignore
    )
in
    Reordered